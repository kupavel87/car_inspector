from datetime import datetime

from webapp import create_app
from webapp.db import db
from webapp.user.models import User
from webapp.map.models import Car, Waybill

app = create_app()

with app.app_context():
    users = [('admin', 'admin.')]
    for username, password in users:
        if not User.query.filter_by(username=username).count():
            new_user = User(username=username, role='admin')
            new_user.set_password(password)
            db.session.add(new_user)
            print(f'Добавлен пользователь {username}')
    db.session.commit()

    cars = {
        "а001аа99": {
            "05.03.2020 12:30": (55.807407, 37.537672),
            "05.03.2020 12:35": (55.805914, 37.539818),
            "05.03.2020 12:40": (55.804228, 37.543422),
            "05.03.2020 12:45": (55.801674, 37.547456),
            "05.03.2020 12:50": (55.799409, 37.550976),
            "05.03.2020 12:55": (55.794635, 37.553808),
            "05.03.2020 13:00": (55.794635, 37.553808),
            "05.03.2020 13:05": (55.794635, 37.553808),
            "05.03.2020 13:10": (55.794396, 37.547714),
            "05.03.2020 13:15": (55.797438, 37.540247),
            "05.03.2020 13:20": (55.801734, 37.529346),
            "05.03.2020 13:25": (55.804342, 37.525655),
            "05.03.2020 13:30": (55.807407, 37.537672),
            "06.03.2020 12:30": (56.807407, 37.537672),
            "06.03.2020 12:35": (56.805914, 37.539818),
            "06.03.2020 12:40": (56.804228, 37.543422),
            "06.03.2020 12:45": (56.801674, 37.547456),
            "06.03.2020 12:50": (56.799409, 37.550976),
            "06.03.2020 12:55": (56.794635, 37.553808),
            "06.03.2020 13:00": (56.794635, 37.553808),
            "06.03.2020 13:05": (56.794635, 37.553808),
            "06.03.2020 13:10": (56.794396, 37.547714),
            "06.03.2020 13:15": (56.797438, 37.540247),
            "06.03.2020 13:20": (56.801734, 37.529346),
            "06.03.2020 13:25": (56.804342, 37.525655),
            "06.03.2020 13:30": (56.807407, 37.537672),
            "07.03.2020 12:30": (55.807407, 37.937672),
            "07.03.2020 12:35": (55.805914, 37.939818),
            "07.03.2020 12:40": (55.804228, 37.943422),
            "07.03.2020 12:45": (55.801674, 37.947456),
            "07.03.2020 12:50": (55.799409, 37.950976),
            "07.03.2020 12:55": (55.794635, 37.953808),
            "07.03.2020 13:00": (55.794635, 37.953808),
            "07.03.2020 13:05": (55.794635, 37.953808),
            "07.03.2020 13:10": (55.794396, 37.947714),
            "07.03.2020 13:15": (55.797438, 37.940247),
            "07.03.2020 13:20": (55.801734, 37.929346),
            "07.03.2020 13:25": (55.804342, 37.925655),
            "07.03.2020 13:30": (55.807407, 37.937672)
        },
        "а007мр199": {
            "10.03.2020 08:20": (55.674126, 37.511493),
            "10.03.2020 08:25": (55.676841, 37.507202),
            "10.03.2020 08:30": (55.683524, 37.519047),
            "10.03.2020 08:35": (55.689722, 37.530204),
            "10.03.2020 08:40": (55.692635, 37.530719),
            "10.03.2020 08:45": (55.692635, 37.530719),
            "10.03.2020 08:50": (55.692635, 37.530719),
            "10.03.2020 08:55": (55.692635, 37.530719),
            "10.03.2020 09:00": (55.688866, 37.543766),
            "10.03.2020 09:05": (55.681903, 37.555954),
            "10.03.2020 09:10": (55.671745, 37.555439),
            "10.03.2020 09:15": (55.665360, 37.545482),
            "10.03.2020 09:20": (55.669044, 37.531749),
            "10.03.2020 09:25": (55.669044, 37.531749),
            "10.03.2020 09:30": (55.672631, 37.522308),
            "10.03.2020 09:35": (55.674126, 37.511493),
            "10.02.2020 08:20": (55.674126, 37.511493),
            "10.02.2020 08:25": (55.676841, 37.507202),
            "10.02.2020 08:30": (55.683524, 37.519047),
            "10.02.2020 08:35": (55.689722, 37.530204),
            "10.02.2020 08:40": (55.692635, 37.530719),
            "10.02.2020 08:45": (55.692635, 37.530719),
            "10.02.2020 08:50": (55.692635, 37.530719),
            "10.02.2020 08:55": (55.692635, 37.530719),
            "10.02.2020 09:00": (55.688866, 37.543766),
            "10.02.2020 09:05": (55.681903, 37.555954),
            "10.02.2020 09:10": (55.671745, 37.555439),
            "10.02.2020 09:15": (55.665360, 37.545482),
            "10.02.2020 09:20": (55.669044, 37.531749),
            "10.02.2020 09:25": (55.669044, 37.531749),
            "10.02.2020 09:30": (55.672631, 37.522308),
            "10.02.2020 09:35": (55.674126, 37.511493)
        }
    }
    for car, dates in cars.items():
        if not Car.query.filter_by(plate=car).count():
            new_car = Car(plate=car)
            db.session.add(new_car)
            print(f"Добавлен автомобиль {car}")

            for date, coord in dates.items():
                new_waybill = Waybill(car=new_car, latitude=coord[0],
                                      longitude=coord[1], timestamp=datetime.strptime(date, "%d.%m.%Y %H:%M"))
                db.session.add(new_waybill)

    db.session.commit()

    print('БД заполнена начальными данными')
